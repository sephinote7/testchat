---
description: Supabase 및 요약 API 사용 규칙 (화상 상담)
globs: "**/*.js,**/*.jsx"
alwaysApply: false
---

# API 및 DB 규칙

## 요약 API (Python 서버)
- **엔드포인트**: `POST ${SUMMARY_API_URL}/api/summarize`
- **FormData 필드**:
  - `audio_user`: 상대(멤버/USER) 음성 Blob, 파일명 `user.webm`
  - `audio_cnsler`: 상담사(SYSTEM) 음성 Blob, 파일명 `cnsler.webm`
  - `msg_data`: 채팅 메시지 배열 JSON 문자열
- API 실패해도 DB 저장은 시도 (요약 실패 시 fallback 텍스트 사용)

## Supabase
- **인증**: `supabase.auth.getSession()`, `onAuthStateChange`, `signOut()`
- **member 테이블**: `id`, `role`, `email`, `nickname`, `mbti`, `persona`, `profile` 조회
  - 이름 표시: member.nickname
  - cnsler(SYSTEM)의 프로필 이미지: member.profile
- **chat_msg**: `chat_id`, `cnsl_id`, `cnsler_id`, `member_id` 조회 후 통화 대상 결정
- **업데이트**(상담사만): `role: 'cnsler'`, `msg_data: { messages }`, `summary` 문자열. `eq('chat_id', session.chat_id)` 후 select

## 메시지 형식 (API/DB)
- 메시지 객체: `type: 'chat'`, `speaker: 'cnsler' | 'user'`, `text`, `timestamp` (문자열)
- 내부 채팅: `from: 'me' | 'remote'`, `text`, `time`. API 전달 시 `from === 'me'` → speaker `cnsler`
