---
description: React 컴포넌트 및 PeerJS/WebRTC 패턴 (화상 상담)
globs: "**/*.jsx"
alwaysApply: false
---

# React 및 WebRTC 패턴

## Ref 사용
- Peer/통화/스트림 등 인스턴스 보관: `peerRef`, `currentCallRef`, `dataConnRef`, `localVideoRef`, `remoteVideoRef`
- 자식 컴포넌트 메서드 호출: `recordPanelRef.current?.stopRecordingAndGetBlobs()` 등
- **한 번만 실행** 보장: `finalizeOnceRef` 같은 플래그로 중복 호출 방지

## Peer ID 규칙 (PeerJS)
- 이메일 기반 ID 생성 시 **특수문자 치환**: `@` → `_at_`, `.` → `_`, 소문자 통일
- PeerJS는 ID에 `.trim()`을 호출하므로 **반드시 문자열**로 전달: `String(remoteId)`, `String(safeId)`

## 통화 제어 메시지 (DataConnection)
- 통화 종료 동기화: `{ type: 'control', action: 'end_call', time: Date.now() }` 전송 후 양쪽에서 `endCall` 처리
- 수신 시 `obj?.type === 'control' && obj?.action === 'end_call'` 조건으로 분기

## Cleanup
- 로그아웃/통화 종료 시: `localStream?.getTracks?.().forEach(t => t.stop())`, `peer.destroy()`, `subscription?.unsubscribe()`
- useEffect return에서 peer destroy 및 ref null 할당

## 에러 처리
- 사용자 facing: 한글 메시지 (alert 또는 state)
- 개발자용: `console.warn` / `console.error`
